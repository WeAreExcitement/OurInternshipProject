@model IEnumerable<DAL.Entities.GPSTrackerMessage>

@using System.Globalization

@{
    ViewBag.Title = "Map";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Карта местоположения маячка</h2>

<button id="start-creation">Отслеживать</button>

@if(Model.Count() == 0)
{
    <div id="noMessage">
        <h4>На данный момент сообщений от маячка не поступало.</h4>
    </div>
}

<div id="googleMap" style="width:1024px;height:768px;"></div>

@section scripts{
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <script src="http://maps.googleapis.com/maps/api/js"></script>
    <script>
            var map;
            var coordinates = [];

            function initialize(latitude, longitude) {
                var mapProp = {
                    center: new google.maps.LatLng(latitude, longitude),
                    zoom: 16,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };

                map = new google.maps.Map(document.getElementById("googleMap"), mapProp);

                coordinates.forEach(function(coordinate, index, ar) {
                    addMarker(coordinate.lat, coordinate.lng, map, markers);
                });
            }

            @if (Model.Count() != 0)
            {
                @:$("googleMap").show();

                <text>
                    google.maps.event.addDomListener(window, 'load', initialize, 
                        @Model.Last().Latitude.ToString((new CultureInfo("en-US")).NumberFormat),
                        @Model.Last().Longitude.ToString((new CultureInfo("en-US")).NumberFormat)))
                    
                </text>

                foreach (var gpsMessage in Model)
                {
                     <text>
                        coordinates.push({
                            lat:@gpsMessage.Latitude.ToString((new CultureInfo("en-US")).NumberFormat),
                            lng:@gpsMessage.Longitude.ToString((new CultureInfo("en-US")).NumberFormat) });
                     </text>
                }
            }
            else
            {
                @:$("googleMap").hide();
            }
    </script>
    <script>
        var markers = [];

        function addMarker(latitude, longitude, map, markers)
        {
            var latLng = new google.maps.LatLng(latitude, longitude);

            if(markers.length == 0){
                $("#noMessage").remove();
                $("googleMap").show();
                initialize(latitude, longitude);
            }

            var marker = new google.maps.Marker({
                position: latLng,
                draggable: false
            });
            marker.setMap(map);
            markers.push(marker);
        }

        function changeMarker(latitude, longitude, map, marker)
        {
            var latLng = new google.maps.LatLng(latitude, longitude);

            marker.setPosition(latLng);

            map.setCenter(latLng);
        }
    </script>
    <script>
        $(function () {
            //событие нажатия на кнопку
            $('#start-creation').on('click', function () {
                $(this).attr("disabled", "disabled");
                $.connection.hub.start();
            });
            //прокси
            var pushNotify = $.connection.pushNotify;

            var markerIndex = 0;

            pushNotify.client.ShowMessage = function (message) {
                if(markers.length < 10){
                    addMarker(message.Latitude, message.Longitude, map, markers);
                } else {
                    changeMarker(message.Latitude, message.Longitude, map, markers[markerIndex]);

                    if(markerIndex < 9){
                        markerIndex++;
                    } else {
                        markerIndex = 0;
                    }
                }
            };
        });
    </script>
}